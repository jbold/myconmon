#!/usr/bin/env bash
# myconmon - Personal Continuous Monitoring
# v0.1 MVP

set -euo pipefail

MYCONMON_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/myconmon"
GOSS_FILE="${GOSS_FILE:-$HOME/config-management/tests/goss.yaml}"
LOG_FILE="$MYCONMON_DIR/events.jsonl"

mkdir -p "$MYCONMON_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

usage() {
    cat <<EOF
myconmon - Personal Continuous Monitoring

Usage: myconmon <command>

Commands:
    check       Run drift check (goss) and report findings
    status      Show last check results
    install     Install systemd timers (boot + weekly)
    uninstall   Remove systemd timers

Options:
    -h, --help  Show this help
EOF
}

notify() {
    local urgency="$1"
    local title="$2"
    local body="$3"
    
    if command -v notify-send &>/dev/null; then
        notify-send -u "$urgency" "$title" "$body"
    fi
    
    # Also log
    echo "{\"timestamp\":\"$(date -Iseconds)\",\"type\":\"notification\",\"urgency\":\"$urgency\",\"title\":\"$title\",\"body\":\"$body\"}" >> "$LOG_FILE"
}

calculate_rpn() {
    local severity="$1"
    local occurrence="$2"
    local detectability="$3"
    
    # RPN = S² × O × D / 13
    echo $(( (severity * severity * occurrence * detectability) / 13 ))
}

phase_from_rpn() {
    local rpn="$1"
    if (( rpn > 300 )); then
        echo "CRITICAL"
    elif (( rpn > 100 )); then
        echo "HIGH"
    elif (( rpn > 30 )); then
        echo "MEDIUM"
    else
        echo "LOW"
    fi
}

cmd_check() {
    echo -e "${YELLOW}Running drift check...${NC}"
    
    if [[ ! -f "$GOSS_FILE" ]]; then
        echo -e "${RED}Error: Goss file not found: $GOSS_FILE${NC}"
        exit 1
    fi
    
    local output
    local exit_code=0
    
    output=$(goss -g "$GOSS_FILE" validate --format json 2>&1) || exit_code=$?
    
    # Parse results
    local total=$(echo "$output" | jq -r '.summary."test-count" // 0')
    local failed=$(echo "$output" | jq -r '.summary."failed-count" // 0')
    local passed=$((total - failed))
    
    # Log the check
    echo "{\"timestamp\":\"$(date -Iseconds)\",\"type\":\"drift_check\",\"total\":$total,\"passed\":$passed,\"failed\":$failed}" >> "$LOG_FILE"
    
    if (( failed == 0 )); then
        echo -e "${GREEN}✓ All $total tests passed${NC}"
        notify "low" "myconmon: Drift Check Passed" "$total tests passed"
    else
        echo -e "${RED}✗ $failed of $total tests failed${NC}"
        
        # Default RPN for drift failures: S=8, O=5, D=5 (config drift is serious but detectable)
        local rpn=$(calculate_rpn 8 5 5)
        local phase=$(phase_from_rpn "$rpn")
        
        echo -e "  RPN: $rpn → Phase: $phase"
        
        # Show failed tests
        echo -e "\nFailed tests:"
        echo "$output" | jq -r '.results[] | select(.successful == false) | "  - \(.resource-type): \(.resource-id)"' 2>/dev/null || true
        
        # Notify based on severity
        if [[ "$phase" == "CRITICAL" ]] || [[ "$phase" == "HIGH" ]]; then
            notify "critical" "myconmon: Drift Detected!" "$failed tests failed (Phase: $phase)"
        else
            notify "normal" "myconmon: Drift Detected" "$failed tests failed (Phase: $phase)"
        fi
    fi
    
    return $exit_code
}

cmd_status() {
    echo -e "${YELLOW}Last 10 events:${NC}"
    if [[ -f "$LOG_FILE" ]]; then
        tail -10 "$LOG_FILE" | jq -c '.' 2>/dev/null || tail -10 "$LOG_FILE"
    else
        echo "No events logged yet."
    fi
}

cmd_install() {
    local user_systemd="$HOME/.config/systemd/user"
    mkdir -p "$user_systemd"
    
    # Single service (used by both timers)
    cat > "$user_systemd/myconmon.service" <<EOF
[Unit]
Description=myconmon drift check

[Service]
Type=oneshot
ExecStart=$HOME/work/myconmon/myconmon check
EOF

    # Boot timer
    cat > "$user_systemd/myconmon-boot.timer" <<EOF
[Unit]
Description=Run myconmon on boot

[Timer]
OnBootSec=2min
Unit=myconmon.service

[Install]
WantedBy=timers.target
EOF

    # Weekly timer
    cat > "$user_systemd/myconmon-weekly.timer" <<EOF
[Unit]
Description=Run myconmon weekly

[Timer]
OnCalendar=weekly
Persistent=true
RandomizedDelaySec=1h
Unit=myconmon.service

[Install]
WantedBy=timers.target
EOF

    systemctl --user daemon-reload
    systemctl --user enable --now myconmon-boot.timer
    systemctl --user enable --now myconmon-weekly.timer
    
    echo -e "${GREEN}✓ Installed and enabled timers${NC}"
    systemctl --user list-timers myconmon*
}

cmd_uninstall() {
    systemctl --user disable --now myconmon-boot.timer 2>/dev/null || true
    systemctl --user disable --now myconmon-weekly.timer 2>/dev/null || true
    rm -f "$HOME/.config/systemd/user/myconmon"*.{service,timer}
    systemctl --user daemon-reload
    echo -e "${GREEN}✓ Removed timers${NC}"
}

# Main
case "${1:-}" in
    check)      cmd_check ;;
    status)     cmd_status ;;
    install)    cmd_install ;;
    uninstall)  cmd_uninstall ;;
    -h|--help)  usage ;;
    *)          usage; exit 1 ;;
esac
